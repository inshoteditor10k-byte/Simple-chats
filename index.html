<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Public Chat App</title>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

    <style>
        :root {
            --primary: #0084ff;
            --bg: #f0f2f5;
            --white: #ffffff;
            --text: #050505;
            --gray: #65676b;
            --border: #ddd;
            --green: #42b72a;
            --red: #ff3b30;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: var(--bg); height: 100vh; overflow: hidden; }
        
        /* Utility */
        .hidden { display: none !important; }
        .btn { border: none; padding: 10px 15px; border-radius: 6px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-green { background: var(--green); color: white; }
        .btn-red { background: var(--red); color: white; }
        .btn-outline { background: transparent; border: 1px solid var(--primary); color: var(--primary); }
        input { padding: 12px; border: 1px solid var(--border); border-radius: 6px; width: 100%; font-size: 16px; outline: none; }

        /* Screens */
        .screen { width: 100%; height: 100%; position: absolute; top: 0; left: 0; background: var(--white); display: flex; flex-direction: column; }

        /* Login */
        #login-screen { justify-content: center; align-items: center; padding: 20px; }
        .login-card { width: 100%; max-width: 400px; text-align: center; }
        .login-card h2 { margin-bottom: 20px; color: var(--primary); }
        .login-card input { margin-bottom: 15px; }
        .login-card button { width: 100%; padding: 12px; font-size: 16px; }

        /* Home */
        #home-screen { background: var(--bg); }
        .top-bar { background: var(--white); padding: 10px; border-bottom: 1px solid var(--border); box-shadow: 0 1px 2px rgba(0,0,0,0.05); z-index: 10; display: flex; gap: 10px; }
        .top-bar input { flex: 1; }
        .tabs { display: flex; justify-content: space-around; background: var(--white); border-bottom: 1px solid var(--border); }
        .tab-btn { flex: 1; padding: 15px 0; background: none; border: none; font-weight: 600; color: var(--gray); cursor: pointer; border-bottom: 3px solid transparent; }
        .tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); }
        
        #user-list { flex: 1; overflow-y: auto; padding: 10px; }
        .user-card { background: var(--white); padding: 15px; margin-bottom: 10px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .user-info h4 { margin: 0 0 5px 0; font-size: 16px; display: flex; align-items: center; }
        .user-info p { margin: 0; color: var(--gray); font-size: 14px; }
        .online-dot { width: 8px; height: 8px; background: var(--green); border-radius: 50%; margin-right: 8px; }
        .offline-dot { width: 8px; height: 8px; background: #f0f2f5; border-radius: 50%; margin-right: 8px; border: 1px solid var(--border); }
        .action-area { display: flex; gap: 5px; }

        /* Chat */
        #chat-screen { display: flex; flex-direction: column; }
        .chat-header { background: var(--white); padding: 10px 15px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; height: 60px; }
        .chat-title { font-weight: bold; font-size: 18px; display: flex; align-items: center; gap: 10px; }
        .chat-controls button { margin-left: 10px; padding: 8px; font-size: 18px; background: none; cursor: pointer; }
        
        #messages-container { flex: 1; overflow-y: auto; padding: 15px; background: #e5ddd5; display: flex; flex-direction: column; gap: 10px; }
        .message { max-width: 75%; padding: 10px 15px; border-radius: 8px; font-size: 15px; line-height: 1.4; word-wrap: break-word; position: relative; }
        .msg-self { align-self: flex-end; background: #dcf8c6; }
        .msg-other { align-self: flex-start; background: var(--white); }
        .msg-time { font-size: 10px; opacity: 0.6; text-align: right; margin-top: 4px; }

        #chat-input-area { padding: 10px; background: var(--white); border-top: 1px solid var(--border); display: flex; gap: 10px; }
        #chat-input-area button { width: 50px; }

        /* Call Modal */
        #call-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 1000; display: flex; flex-direction: column; }
        #remote-video { width: 100%; flex: 1; object-fit: cover; background: #222; }
        #local-video { position: absolute; bottom: 80px; right: 20px; width: 100px; height: 150px; object-fit: cover; border: 2px solid white; border-radius: 8px; background: #333; }
        .call-controls { position: absolute; bottom: 20px; left: 0; width: 100%; display: flex; justify-content: center; gap: 20px; }
        .call-btn-end { background: var(--red); width: 60px; height: 60px; border-radius: 50%; color: white; font-size: 24px; display: flex; align-items: center; justify-content: center; border: none; cursor: pointer; }
        .call-status { position: absolute; top: 20px; left: 0; width: 100%; text-align: center; color: white; text-shadow: 0 1px 3px rgba(0,0,0,0.8); pointer-events: none; font-size: 18px; }
    </style>
</head>
<body>

    <!-- LOGIN SCREEN -->
    <div id="login-screen" class="screen">
        <div class="login-card">
            <h2>üî• Public Chat App üî•</h2>
            <input type="text" id="login-name" placeholder="Enter your Name">
            <input type="tel" id="login-mobile" placeholder="Mobile Number (Unique ID)">
            <button class="btn btn-primary" onclick="app.login()">Start Chatting</button>
        </div>
    </div>

    <!-- HOME SCREEN -->
    <div id="home-screen" class="screen hidden">
        <div class="top-bar">
            <input type="text" id="search-input" placeholder="Search users..." onkeyup="app.handleSearch()">
            <button class="btn btn-red" style="padding: 5px 10px; font-size: 12px;" onclick="app.logout()">Logout</button>
        </div>
        <div class="tabs">
            <button class="tab-btn active" onclick="app.switchTab('suggestions')">Suggestions</button>
            <button class="tab-btn" onclick="app.switchTab('friends')">Friends</button>
            <button class="tab-btn" onclick="app.switchTab('requests')">Requests</button>
        </div>
        <div id="user-list"></div>
    </div>

    <!-- CHAT SCREEN -->
    <div id="chat-screen" class="screen hidden">
        <div class="chat-header">
            <div class="chat-title">
                <button class="btn btn-outline" style="border:none; padding:0; font-size:20px;" onclick="app.goHome()">&#8592;</button>
                <span id="chat-user-name">User</span>
            </div>
            <div class="chat-controls">
                <button onclick="app.startCall('audio')" title="Voice Call">üìû</button>
                <button onclick="app.startCall('video')" title="Video Call">üé•</button>
            </div>
        </div>
        <div id="messages-container"></div>
        <div id="chat-input-area">
            <input type="text" id="msg-input" placeholder="Type a message..." onkeypress="if(event.key==='Enter') app.sendMessage()">
            <button class="btn btn-primary" onclick="app.sendMessage()">‚û§</button>
        </div>
    </div>

    <!-- CALL UI (Overlay) -->
    <div id="call-modal" class="hidden">
        <div class="call-status" id="call-status">Calling...</div>
        <video id="remote-video" autoplay playsinline muted></video>
        <video id="local-video" autoplay playsinline muted></video>
        <div class="call-controls">
            <button class="call-btn-end" onclick="app.endCall()">‚ùå</button>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDZdmA4KWuZXkM7tS64_bInJSN1X-TizC4",
            authDomain: "public-chat-app-ec084.firebaseapp.com",
            databaseURL: "https://public-chat-app-ec084-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "public-chat-app-ec084",
            storageBucket: "public-chat-app-ec084.firebasestorage.app",
            messagingSenderId: "243578195275",
            appId: "1:243578195275:web:971f9bf2d4cdb3ab976cce",
            measurementId: "G-W03T50RT1Q"
        };

        // Initialize Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.database();
        const auth = firebase.auth();

        // --- FIXED ChatApp Class ---
        class ChatApp {
            constructor() {
                this.currentUser = null;
                this.currentTab = 'suggestions';
                this.activeChatId = null;
                this.activeChatPartner = null;
                this.allUsers = {};
                this.relationships = {};
                this.peerConnection = null;
                this.localStream = null;
                
                this.iceServers = {
                    iceServers: [
                        { urls: 'stun:stun.l.google.com:19302' },
                        { urls: 'stun:stun1.l.google.com:19302' }
                    ]
                };

                this.init();
            }

            async init() {
                await auth.signInAnonymously().catch(console.error);
                const savedUser = localStorage.getItem("chat_user");
                
                if (savedUser) {
                    const userData = JSON.parse(savedUser);
                    this.fetchUserProfile(userData.mobile);
                }
            }

            async login() {
                const name = document.getElementById('login-name').value.trim();
                const mobile = document.getElementById('login-mobile').value.trim().replace(/D/g, '');

                if (!name || !mobile || mobile.length < 10) {
                    return alert("Valid Name ‡§î‡§∞ 10 digit Mobile Number ‡§°‡§æ‡§≤‡•ã");
                }

                localStorage.setItem("chat_user", JSON.stringify({ name: name, mobile: mobile }));

                await db.ref('users/' + mobile).update({
                    name: name,
                    mobile: mobile,
                    last_seen: firebase.database.ServerValue.TIMESTAMP,
                    online: true
                });

                // Keep online status updated
                setInterval(() => {
                    if (this.currentUser) {
                        db.ref('users/' + this.currentUser.mobile).update({
                            last_seen: firebase.database.ServerValue.TIMESTAMP,
                            online: document.visibilityState === 'visible'
                        });
                    }
                }, 30000);

                this.fetchUserProfile(mobile);
            }

            logout() {
                if (this.currentUser) {
                    db.ref('users/' + this.currentUser.mobile).update({ online: false });
                }
                localStorage.removeItem("chat_user");
                location.reload();
            }

            fetchUserProfile(mobile) {
                db.ref('users/' + mobile).once('value', snapshot => {
                    const user = snapshot.val();
                    if (user) {
                        this.currentUser = user;
                        this.showScreen('home-screen');
                        this.startListeners();
                        this.renderList();
                    } else {
                        this.logout();
                    }
                });
            }

            startListeners() {
                db.ref('users').on('value', snapshot => {
                    this.allUsers = snapshot.val() || {};
                    this.renderList();
                });

                db.ref(`relationships/${this.currentUser.mobile}`).on('value', snapshot => {
                    this.relationships = snapshot.val() || {};
                    this.renderList();
                });
            }

            switchTab(tab) {
                this.currentTab = tab;
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                event.target.classList.add('active');
                this.renderList();
            }

            handleSearch() {
                this.renderList(document.getElementById('search-input').value.toLowerCase());
            }

            renderList(filter = "") {
                const container = document.getElementById('user-list');
                container.innerHTML = "";

                if (!this.currentUser) return;

                const users = Object.values(this.allUsers);
                const now = Date.now();
                
                users.forEach(user => {
                    if (user.mobile === this.currentUser.mobile) return;

                    const lastSeen = user.last_seen || 0;
                    const isOnline = (now - lastSeen) < 30000; // 30 seconds
                    
                    const rel = this.relationships[user.mobile] || { status: 'none' };
                    let show = false;
                    let actionHtml = "";

                    if (this.currentTab === 'suggestions') {
                        if (rel.status !== 'friend' && rel.status !== 'incoming_request') {
                            show = true;
                            actionHtml = `<button class="btn btn-primary" onclick="app.followUser('${user.mobile}')">Follow</button>`;
                        }
                    } else if (this.currentTab === 'friends') {
                        if (rel.status === 'friend') {
                            show = true;
                            actionHtml = `<button class="btn btn-primary" onclick="app.openChat('${user.mobile}')">Chat</button>`;
                        }
                    } else if (this.currentTab === 'requests') {
                        if (rel.status === 'incoming_request') {
                            show = true;
                            actionHtml = `<button class="btn btn-green" onclick="app.acceptRequest('${user.mobile}')">Follow Back</button>`;
                        }
                    }

                    if (filter) {
                        if (user.name.toLowerCase().includes(filter) || user.mobile.includes(filter)) {
                            show = true;
                            if (rel.status === 'friend') {
                                actionHtml = `<button class="btn btn-primary" onclick="app.openChat('${user.mobile}')">Chat</button>`;
                            } else if (rel.status === 'following') {
                                actionHtml = `<button class="btn btn-outline" disabled>Requested</button>`;
                            } else if (rel.status === 'incoming_request') {
                                actionHtml = `<button class="btn btn-green" onclick="app.acceptRequest('${user.mobile}')">Accept</button>`;
                            } else {
                                actionHtml = `<button class="btn btn-primary" onclick="app.followUser('${user.mobile}')">Follow</button>`;
                            }
                        }
                    }

                    if (show) {
                        const statusDot = isOnline ? '<span class="online-dot"></span>' : '<span class="offline-dot"></span>';
                        const card = document.createElement('div');
                        card.className = 'user-card';
                        card.innerHTML = `
                            <div class="user-info">
                                <h4>${statusDot}${user.name}</h4>
                                <p>${user.mobile} ${isOnline ? '(Online)' : '(Offline)'}</p>
                            </div>
                            <div class="action-area">${actionHtml}</div>
                        `;
                        container.appendChild(card);
                    }
                });
            }

            followUser(targetMobile) {
                db.ref(`relationships/${this.currentUser.mobile}/${targetMobile}`).set({ status: 'following' });
                db.ref(`relationships/${targetMobile}/${this.currentUser.mobile}`).set({ status: 'incoming_request' });
            }

            acceptRequest(targetMobile) {
                db.ref(`relationships/${this.currentUser.mobile}/${targetMobile}`).set({ status: 'friend' });
                db.ref(`relationships/${targetMobile}/${this.currentUser.mobile}`).set({ status: 'friend' });
            }

            openChat(partnerMobile) {
                this.activeChatPartner = this.allUsers[partnerMobile];
                const ids = [this.currentUser.mobile, partnerMobile].sort();
                this.activeChatId = ids[0] + "_" + ids[1];

                document.getElementById('chat-user-name').innerText = this.activeChatPartner.name;
                document.getElementById('messages-container').innerHTML = "";
                
                this.showScreen('chat-screen');
                
                db.ref(`chats/${this.activeChatId}`).off();
                db.ref(`chats/${this.activeChatId}`).orderByChild('timestamp').limitToLast(50).on('child_added', snapshot => {
                    const msg = snapshot.val();
                    if (msg.type === 'text') {
                        this.appendMessage(msg);
                    } else if (['offer', 'answer', 'candidate'].includes(msg.type)) {
                        this.handleSignalMessage(msg);
                    }
                });
            }

            sendMessage() {
                const input = document.getElementById('msg-input');
                const text = input.value.trim();
                if (!text) return;

                db.ref(`chats/${this.activeChatId}`).push({
                    sender: this.currentUser.mobile,
                    text: text,
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    type: 'text'
                });
                input.value = "";
            }

            appendMessage(msg) {
                const container = document.getElementById('messages-container');
                const div = document.createElement('div');
                const isSelf = msg.sender === this.currentUser.mobile;
                div.className = `message ${isSelf ? 'msg-self' : 'msg-other'}`;
                
                const time = new Date(msg.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                div.innerHTML = `${msg.text}<div class="msg-time">${time}</div>`;
                
                container.appendChild(div);
                container.scrollTop = container.scrollHeight;
            }

            goHome() {
                if (this.activeChatId) {
                    db.ref(`chats/${this.activeChatId}`).off();
                }
                this.activeChatId = null;
                this.activeChatPartner = null;
                this.endCall();
                this.showScreen('home-screen');
            }

            // ‚úÖ FIXED WebRTC - WORKING VOICE & VIDEO CALLS
            async startCall(type) {
                if (!this.activeChatId) return;

                document.getElementById('call-modal').classList.remove('hidden');
                document.getElementById('call-status').innerText = `Calling ${this.activeChatPartner.name}...`;

                this.peerConnection = new RTCPeerConnection(this.iceServers);
                
                this.peerConnection.ontrack = (event) => {
                    document.getElementById('remote-video').srcObject = event.streams[0];
                };

                this.peerConnection.onicecandidate = (event) => {
                    if (event.candidate) {
                        this.sendSignal('candidate', event.candidate);
                    }
                };

                try {
                    const constraints = type === 'video' ? 
                        { video: { width: 640, height: 480 }, audio: true } : 
                        { video: false, audio: true };
                    
                    this.localStream = await navigator.mediaDevices.getUserMedia(constraints);
                    document.getElementById('local-video').srcObject = this.localStream;
                    
                    this.localStream.getTracks().forEach(track => {
                        this.peerConnection.addTrack(track, this.localStream);
                    });

                    const offer = await this.peerConnection.createOffer({
                        offerToReceiveAudio: true,
                        offerToReceiveVideo: true
                    });
                    await this.peerConnection.setLocalDescription(offer);
                    this.sendSignal('offer', offer);
                    
                } catch (e) {
                    console.error('Call error:', e);
                    alert("Camera/Mic permission deny ‡§ï‡§∞ ‡§¶‡§ø‡§Ø‡§æ! Allow ‡§ï‡§∞‡•ã‡•§");
                    this.endCall();
                }
            }

            sendSignal(type, data) {
                db.ref(`chats/${this.activeChatId}`).push({
                    sender: this.currentUser.mobile,
                    type: type,
                    data: JSON.stringify(data),
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                });
            }

            async handleSignalMessage(msg) {
                if (msg.sender === this.currentUser.mobile) return;
                
                try {
                    const data = JSON.parse(msg.data);

                    if (msg.type === 'offer') {
                        const accept = confirm(`${this.activeChatPartner.name} calling! Answer ‡§ï‡§∞‡•ã?`);
                        if (!accept) return;

                        document.getElementById('call-modal').classList.remove('hidden');
                        document.getElementById('call-status').innerText = "Connecting...";

                        this.peerConnection = new RTCPeerConnection(this.iceServers);
                        
                        this.peerConnection.ontrack = (event) => {
                            document.getElementById('remote-video').srcObject = event.streams[0];
                            document.getElementById('call-status').innerText = "‚úÖ Connected";
                        };

                        this.peerConnection.onicecandidate = (event) => {
                            if (event.candidate) {
                                this.sendSignal('candidate', event.candidate);
                            }
                        };

                        await this.peerConnection.setRemoteDescription(new RTCSessionDescription(data));
                        
                        try {
                            this.localStream = await navigator.mediaDevices.getUserMedia({ 
                                video: true, 
                                audio: true 
                            });
                            document.getElementById('local-video').srcObject = this.localStream;
                            this.localStream.getTracks().forEach(track => {
                                this.peerConnection.addTrack(track, this.localStream);
                            });
                        } catch (e) {
                            this.localStream = await navigator.mediaDevices.getUserMedia({ 
                                video: false, 
                                audio: true 
                            });
                            document.getElementById('local-video').srcObject = this.localStream;
                            this.localStream.getTracks().forEach(track => {
                                this.peerConnection.addTrack(track, this.localStream);
                            });
                        }

                        const answer = await this.peerConnection.createAnswer();
                        await this.peerConnection.setLocalDescription(answer);
                        this.sendSignal('answer', answer);
                        
                    } else if (msg.type === 'answer' && this.peerConnection) {
                        await this.peerConnection.setRemoteDescription(new RTCSessionDescription(data));
                        document.getElementById('call-status').innerText = "‚úÖ Connected";
                        
                    } else if (msg.type === 'candidate' && this.peerConnection) {
                        await this.peerConnection.addIceCandidate(new RTCIceCandidate(data));
                    }
                } catch (e) {
                    console.error('Signal error:', e);
                }
            }

            endCall() {
                if (this.peerConnection) {
                    this.peerConnection.close();
                    this.peerConnection = null;
                }
                if (this.localStream) {
                    this.localStream.getTracks().forEach(track => track.stop());
                    this.localStream = null;
                }
                document.getElementById('call-modal').classList.add('hidden');
                document.getElementById('remote-video').srcObject = null;
                document.getElementById('local-video').srcObject = null;
                document.getElementById('call-status').innerText = "Calling...";
            }

            showScreen(screenId) {
                document.querySelectorAll('.screen').forEach(el => el.classList.add('hidden'));
                document.getElementById(screenId).classList.remove('hidden');
            }
        }

        const app = new ChatApp();
    </script>
</body>
</html>
